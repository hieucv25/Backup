<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" data-layout="vertical" data-topbar="light" data-sidebar="light"
      data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable" data-body-image="none">
<head th:replace="admin/fragments/head::head"></head>
<body>
<!-- Begin page -->
<div id="layout-wrapper">
    <div th:replace="admin/fragments/header::header"></div>
    <!-- ========== App Menu ========== -->
    <div th:replace="admin/fragments/sidebar::sidebar"></div>
    <!-- Left Sidebar End -->
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                            <h4 class="mb-sm-0">Bán hàng</h4>

                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="javascript: void(0);">Bán hàng</a></li>
                                    <li class="breadcrumb-item active">Tại quầy</li>
                                </ol>
                            </div>

                        </div>
                    </div>
                </div>
                <!-- end page title -->
                <!--end row-->
                <form autocomplete="off" class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-xl-9 col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="avatar-sm">
                                                <div class="avatar-title rounded-circle bg-light text-primary fs-20">
                                                    <i class="bi bi-receipt"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="card-title mb-1">Hóa đơn chờ</h5>
                                            <p class="text-muted mb-0">Pending Invoice</p>
                                        </div>

                                        <div class="row g-lg-2 g-4">
                                            <div class="col-lg-auto col-sm-3 ms-auto"><a
                                                    onclick="createInvoice()"
                                                    class="btn btn-primary w-100 add-btn">
                                                Thêm
                                            </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="hoaDonChoList">
                                        <div class="col-lg-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row g-lg-2 g-4">
                                                        <div class="col-lg-3">
                                                            <div class="search-box">
                                                                <input type="text" class="form-control search"
                                                                       placeholder="Search ..." id="search-input"
                                                                       onkeyup="searchSell()">
                                                                <i class="ri-search-line search-icon"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="gridjs-border-none mb-4">
                                                        <table class="table align-middle table-nowrap"
                                                        >
                                                            <thead class="table-light">
                                                            <tr>
                                                                <th>STT</th>
                                                                <th>Nhân Viên</th>
                                                                <th>Mã Hóa Đơn</th>
                                                                <th>Thời Gian Tạo</th>
                                                                <th>Trạng Thái</th>
                                                                <th>Action</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody class="list form-check-all" id="list_Sell">
                                                            </tbody>
                                                        </table>
                                                        <div class="row">
                                                            <div class="col-lg-3"></div>
                                                            <div class="col-lg-1"></div>
                                                            <div class="col-lg-4">
                                                                <nav aria-label="Page navigation example">
                                                                    <ul class="pagination justify-content-center"
                                                                        id="pagination">
                                                                    </ul>
                                                                </nav>
                                                            </div>
                                                            <div class="col-lg-3"></div>
                                                            <div class="col-lg-1"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- end card -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="avatar-sm">
                                                <div class="avatar-title rounded-circle bg-light text-primary fs-20">
                                                    <i class="bi bi-box2"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="card-title mb-1">Sản phẩm</h5>
                                            <p class="text-muted mb-0">Product</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="sanPhamChiTietList">
                                        <div class="col-lg-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row g-lg-2 g-4">
                                                        <div class="col-lg-3">
                                                            <div class="search-box">
                                                                <input id="search" type="text"
                                                                       class="form-control search"
                                                                       placeholder="Tìm kiếm sản phẩm">
                                                                <i class="ri-search-line search-icon"></i>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <select id="sort" class="form-control"
                                                                    onchange="loadSpChiTiet(0)">
                                                                <option value="sp.donGia,asc">Giá tăng dần</option>
                                                                <option value="sp.donGia,desc">Giá giảm dần</option>
                                                                <option value="sp.tenSP,asc">Tên sản phẩm a-z</option>
                                                                <option value="sp.tenSP,desc">Tên sản phẩm z-a</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <button onclick="loadSpChiTiet(0)" type="button"
                                                                    class="btn btn-primary">Tìm kiếm
                                                            </button>
                                                        </div>
                                                        <div class="col-lg-3">
                                                            <button type="button" onclick="addToCart()"
                                                                    class="btn btn-primary">Thêm vào giỏ hàng
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="table-responsive table-card mb-1">
                                                        <table class="table align-middle table-nowrap"
                                                               id="customerTable2">
                                                            <thead class="table-light">
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Tên sản phẩm</th>
                                                                <th>Màu sắc</th>
                                                                <th>Kích thước</th>
                                                                <th>Số lượng</th>
                                                                <th>Đơn giá</th>
                                                                <th>Action</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody class="list form-check-all" id="listspct">
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="d-flex justify-content-center">
                                                        <div class="pagination-wrap hstack gap-2">
                                                            <a class="page-item pagination-prev" id="prectsp">
                                                                <i class="mdi mdi-chevron-double-left align-middle ms-1"></i>
                                                            </a>
                                                            <ul class="pagination listjs-pagination mb-0" id="pagespct">
                                                                <li class="active"><a class="page" data-i="1"
                                                                                      data-page="10">1</a></li>
                                                            </ul>
                                                            <a class="page-item pagination-next" id="nextctsp">
                                                                <i class="mdi mdi-chevron-double-right align-middle ms-1"></i></a>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- end card -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0 me-3">
                                            <div class="avatar-sm">
                                                <div class="avatar-title rounded-circle bg-light text-primary fs-20">
                                                    <i class="bi bi-cart2"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="card-title mb-1">Giỏ hàng</h5>
                                            <p class="text-muted mb-0">Card</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="gioHangList">
                                        <div class="col-lg-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row g-lg-2 g-4">
                                                        <div class="col-lg-3">
                                                            <div class="search-box">
                                                                <input type="text" class="form-control search"
                                                                       placeholder="...">
                                                                <i class="ri-search-line search-icon"></i>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-auto col-sm-9">
                                                            <div class="col-sm-12 d-lg-flex justify-content-end">
                                                                <div onclick="exportInvoice()" class="btn btn-primary">
                                                                    Xuất Hoá Đơn
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="table-responsive table-card mb-1">
                                                        <table class="table align-middle table-nowrap"
                                                               id="customerTable3">
                                                            <thead class="table-light">
                                                            <tr>
                                                                <th class="text-start">STT</th>
                                                                <!--                                                                <th>ID</th>-->
                                                                <th class="text-start">Tên</th>
                                                                <th class="text-start">Màu Sắc</th>
                                                                <th class="text-start">Kích Thước</th>
                                                                <th class="text-start">Số Lượng</th>
                                                                <th class="text-start">Đơn Giá</th>
                                                                <th class="text-start">Action</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody class="list form-check-all"
                                                                   id="list_product_detail_of_cart">
                                                            </tbody>
                                                        </table>
                                                        <div class="row">
                                                            <div class="col-lg-3"></div>
                                                            <div class="col-lg-1"></div>
                                                            <div class="col-lg-4">
                                                                <nav aria-label="Page navigation example">
                                                                    <ul class="pagination justify-content-center"
                                                                        id="pagination_cart">
                                                                    </ul>
                                                                </nav>
                                                            </div>
                                                            <div class="col-lg-3"></div>
                                                            <div class="col-lg-1"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- end card -->
                        </div>
                        <div class="col-xl-3 col-lg-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="section">
                                            <div id="my-qr-reader">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Thông tin đơn hàng</h6>
                                </div>
                                <!-- end card body -->
                                <div class="card-body">
                                    <div class="">
                                        <label for="staff-name-input" class="form-label">Nhân viên</label>
                                        <input type="text" id="staff-name-input" class="form-control" placeholder="">
                                    </div>
                                    <div>
                                        <label for="datetime-input" class="form-label">Thời gian</label>
                                        <input type="text" id="datetime-input" class="form-control" placeholder="">
                                    </div>
                                    <div>
                                        <label for="customer-name-input" class="form-label">Khách hàng</label>
                                        <input type="text" id="customer-phone-input" class="form-control"
                                               placeholder="">
                                        <br>
                                        <input type="text" id="customer-name-input" class="form-control" placeholder="">
                                        <div>
                                            <label for="voucher-input" class="form-label">Mã voucher</label>
                                            <input type="text" id="voucher-input" class="form-control" placeholder="">
                                        </div>

                                        <div>
                                            <label for="total-amount-input" class="form-label">Tổng tiền</label>
                                            <input type="text" id="total-amount-input" class="form-control"
                                                   placeholder="">
                                        </div>
                                    </div>
                                </div>
                                <!-- end card -->
                            </div>
                        </div>
                    </div>
                    <!-- end col -->
                </form>
            </div>
        </div>
    </div>
</div>
<!-- end row -->
</div>
<!-- End Page-content -->
</div>
<div class="modal" id="myModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="label-modal">Hoá Đơn</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-invoice" action="" class="my-form">
                    <div class="card">
                        <div class="card-header">
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive table-card mb-1">
                                    <table class="table align-middle table-nowrap"
                                           id="table-export-invoice">
                                        <thead class="table-light">
                                        <tr>
                                            <th class="text-start">STT</th>
                                            <th class="text-start">Tên</th>
                                            <th class="text-start">Màu Sắc</th>
                                            <th class="text-start">Kích Thước</th>
                                            <th class="text-start">Số Lượng</th>
                                            <th class="text-start">Đơn Giá</th>
                                            <th class="text-start">Thành Tiền</th>
                                        </tr>
                                        </thead>
                                        <tbody class="list form-check-all"
                                               id="list_product_modal">
                                        </tbody>
                                        <tfoot>
                                        <tr>
                                            <td colspan="6" class="text-end"><strong>Thời Gian:</strong></td>
                                            <td class="text-center" id="date-time"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="6" class="text-end"><strong>Tổng tiền:</strong></td>
                                            <td class="text-start" id="total-amount"></td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Đóng
                            </button>
                        </div>
                        <!-- end row -->
                    </div>
                </form>
            </div>
            <!-- end col -->
        </div>
        <!-- end row -->
    </div>
</div>
<!--end modal-->
</div>
<!-- end main content-->
</div>
<!-- END layout-wrapper -->
</div>
<div th:replace="admin/fragments/chat::chat"></div>
<div th:replace="admin/fragments/themeSettings::themeSettings"></div>
<div th:replace="admin/fragments/script::script"></div>
</body>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
<script th:inline="javascript">

    // lưu page index đang select của table
    var page;

    var pageProduct;

    var pageCart;

    var size = 5;

    // lưu id hoá đơn đang được select
    var selectedInvoiceId = null;

    // lưu thẻ được select của bảng hoá đơn
    var lastSelectedCheckbox = null;

    // lưu id sản phẩm chi tiết đang được select
    var selectedProductDetailId = [];

    window.onload = function () {
        //Cập nhật lại trạng thái checked của checkbox trong table hoá đơn
        var checkboxes = document.querySelectorAll('.form-check-input');
        checkboxes.forEach(function (checkbox) {
            checkbox.checked = false;
        });
        loadPage(0);
        loadSpChiTiet(0);
        loadTableCart(0);
    }

    async function loadPage(pageNumber) {
        var url = "/api/admin/sell-off/page/" + pageNumber;
        const response = await fetch(url, {
            method: 'GET'
        });
        page = pageNumber;
        var result = await response.json();
        console.log(result);
        var list = result.content;
        var totalPage = result.totalPages;
        var number = result.number;
        var main = '';
        for (i = 0; i < list.length; i++) {
            const formattedCreateAt = moment(list[i].ngayTao).format('DD/MM/YY HH:mm:ss');
            var idCheckbox = 'checkboxNoLabel' + list[i].id;
            var trangThaiBadge = (list[i].trangThai == 0) ? '<span class="badge bg-success">Chờ</span>' : '<span class="badge bg-success">Ngừng Hoạt Động</span>';
            main += `<tr >
                            <td scope="row">${i + 1}</td>
                            <td scope="row">${list[i].nv.hoTen}</td>
                            <td scope="row">${list[i].maDonHang}</td>
                             <td scope="row">${formattedCreateAt}</td>
                            <td>${trangThaiBadge}</td>
                            <td>
                                <div class="hstack gap-3 flex-warp">
                                    <div onclick="deleteDH(${list[i].id})"class="link-danger fs-15"><i class="ri-delete-bin-6-line"></i></div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="${idCheckbox}"
                                        aria-label="..." onclick="chooseInvoice(${list[i].id})"                                        />
                                    </div>
                                </div>
                            </td>
                     </tr>`
        }
        document.getElementById("list_Sell").innerHTML = main;
        var currentPage = `
            <li class="page-item">
                <button class="page-link" onclick="event.preventDefault(); loadPage(0)" aria-label="First">First</button>
            </li>
            <li class="page-item">
                <button class="page-link" aria-label="Previous" onclick="event.preventDefault(); loadPage(${number - 1 < 0 ? totalPage - 1 : number - 1})"><span aria-hidden="true">&laquo;</span></button>
            </li>
            <li class="page-item">
                <button class="page-link">${number + 1}</button>
            </li>
            <li class="page-item">
                <button class="page-link" aria-label="Next" onclick="event.preventDefault(); loadPage(${number + 1 === totalPage ? 0 : number + 1})">
                   <span aria-hidden="true">&raquo;</span>
                 </button>
            </li>
            <li class="page-item">
                <button class="page-link" onclick="event.preventDefault(); loadPage(${totalPage - 1})" aria-label="Last">Last</button>
            </li>
        `;
        document.getElementById("pagination").innerHTML = currentPage;
    }

    async function searchSell(pageNumber) {

        var keyword = document.getElementById("search-input").value.trim().toLowerCase();
        var url;

        pageNumber === undefined ? page = 0 : page = pageNumber;

        if (pageNumber === undefined && keyword === '') {
            loadPage(0);
        }
        if (pageNumber === undefined && keyword !== '') {
            url = "/api/admin/sell-off/page/" + 0;
            console.log(url);
        }
        if (pageNumber !== undefined && keyword !== '') {
            url = "/api/admin/sell-off/page/search/" + pageNumber + "/" + keyword;
        }
        const response = await fetch(url, {
            method: 'GET'
        });
        var result = await response.json();
        console.log(result);
        var list = result.content;
        var totalPage = result.totalPages;
        var number = result.number;
        var main = '';
        for (i = 0; i < list.length; i++) {
            const formattedCreateAt = moment(list[i].ngayTao).format('DD/MM/YY HH:mm:ss');
            var trangThaiBadge = (list[i].trangThai == 0) ? '<span class="badge bg-success">Chờ</span>' : '<span class="badge bg-success">Ngừng Hoạt Động</span>';
            main += `<tr ><td scope="row">${i + 1}</td>
                            <td scope="row">${list[i].nv.hoTen}</td>
                             <td scope="row">${list[i].maDonHang}</td>
                             <td scope="row">${formattedCreateAt}</td>
                            <td>${trangThaiBadge}</td>
                             <td>
                                <div class="hstack gap-3 flex-warp">
                                <div onclick="deleteDH(${list[i].id})"
                                     class="link-danger fs-15"><i class="ri-delete-bin-6-line"></i></div>
                                </div>
                                <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="${idCheckbox}"
                                        aria-label="..." onclick="chooseInvoice(${list[i].id})"                                        />
                                </div>
                            </td>
                     </tr>`
        }

        document.getElementById("list_Sell").innerHTML = main;
        var currentPage = `
            <li class="page-item">
                    <button class="page-link" onclick="searchProduct(0)" aria-label="First">First</button>
            </li>
            <li class="page-item">
                    <button class="page-link" aria-label="Previous" onclick="searchSell(${number - 1 < 0 ? totalPage - 1 : number - 1})"><span aria-hidden="true">&laquo;</span></button>
            </li>
            <li class="page-item">
                    <button class="page-link">${number + 1}</button>
            </li>
            </li>
            <li class="page-item">
                    <button class="page-link" aria-label="Next" onclick="searchSell(${number + 1 === totalPage ? 0 : number + 1})">
                       <span aria-hidden="true">&raquo;</span>
                     </button>
            </li>
            <li class="page-item">
                    <button class="page-link" onclick="searchSell(${totalPage - 1})" aria-label="Last">Last</button>
            </li>
        `;
        document.getElementById("pagination").innerHTML = currentPage;
    }

    async function createInvoice() {
        $.ajax({
            url: '/admin/sell-off/save_invoice',
            method: 'GET',
            success: function (response) {
                console.log(response);
                if (response === "success") {
                    loadPage(0);
                    swal.fire({
                        title: "Success!",
                        imageUrl: '/assets/images/cheems-cool-1.jpg',
                        imageWidth: 300, // Độ rộng của ảnh
                        imageHeight: 280, // Độ cao của ảnh
                        confirmButtonText: 'Ok rồi em nhá!'
                    })
                }
                if (response === "fail") {
                    swal.fire({
                        title: "Failure!",
                        imageUrl: '/assets/images/cheems-meme-2.jpg',
                        imageWidth: 300, // Độ rộng của ảnh
                        imageHeight: 280, // Độ cao của ảnh
                        confirmButtonText: 'Đủ rồi em!'
                    })
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function chooseInvoice(id) {
        var currentCheckbox = document.getElementById('checkboxNoLabel' + id);

        if (lastSelectedCheckbox !== null && lastSelectedCheckbox !== currentCheckbox) {
            // Hủy chọn checkbox trước đó nếu có
            lastSelectedCheckbox.checked = false;
        }

        // Cập nhật checkbox được chọn gần đây nhất
        lastSelectedCheckbox = currentCheckbox;
        selectedInvoiceId = id;
    }

    function chooseProductDetail(id) {
        var currentCheckbox = document.getElementById('checkboxProductDetail' + id);
        console.log(selectedProductDetailId);
        console.log(currentCheckbox);

        // Kiểm tra xem ID đã được chọn có trong danh sách hay không?
        var index = selectedProductDetailId.indexOf(id);

        if (index === -1) {
            // Nếu không tìm thấy, thêm ID vào danh sách!
            selectedProductDetailId.push(id);
            console.log(selectedProductDetailId);
        } else {
            // Nếu tìm thấy, loại bỏ ID khỏi danh sách!
            selectedProductDetailId.splice(index, 1);
            console.log(selectedProductDetailId);
        }
    }

    function addToCart() {
        if (selectedProductDetailId.length > 0 && selectedInvoiceId !== null) {
            for (i = 0; i < selectedProductDetailId.length; i++) {
                const ghct = {
                    "idGioHang": "1",
                    "soLuong": "1",
                    "idSanPhamChiTiet": selectedProductDetailId[i]
                }
                console.log(ghct);

                $.ajax({
                    url: '/api/admin/sell-off/cart/save',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(ghct),
                    success: function (response) {
                        console.log(response);
                        if (response === "success") {
                            loadTableCart(pageCart);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                    }
                });
            }

        } else if (selectedInvoiceId === null) {
            swal.fire({
                text: "Chưa Chọn Hoá Đơn Kìa Em!",
                title: "Boong!",
                imageUrl: '/assets/images/meme-cheems.jpg',
                imageWidth: 300, // Độ rộng của ảnh
                imageHeight: 280, // Độ cao của ảnh
                confirmButtonText: 'Dạ em biết sai rồi ạ!'
            })
        } else {
            swal.fire({
                text: "Chưa Chọn Sản Phẩm Kìa Em!",
                title: "Boong!",
                imageUrl: '/assets/images/meme-cheems.jpg',
                imageWidth: 300, // Độ rộng của ảnh
                imageHeight: 280, // Độ cao của ảnh
                confirmButtonText: 'Dạ em biết sai rồi ạ!'
            })
        }
    }

    async function deleteDH(id) {
        console.log(id);
        swal.fire({
            title: "Bạn Có Muốn Xoá?",
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: "Xoá",
            denyButtonText: `Quay Về`
        }).then((result) => {
            if (result.isConfirmed) {
                var url = '/api/admin/sell-off/delete/' + id;
                const promise = fetch(url, {
                    method: 'GET'
                });
                promise.then(response => {
                    if (response.status === 200) {
                        Swal.fire({
                            icon: "success",
                            title: "Xoá thành công!"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                loadPage(page);
                            }
                        })
                    }
                })
            }
        });
    }

    function formatmoney(money) {
        const VND = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
        });
        return VND.format(money);
    }

    function restoreCheckedState() {
        selectedProductDetailId.forEach(function (id) {
            var currentCheckbox = document.getElementById('checkboxProductDetail' + id);
            if (currentCheckbox) {
                currentCheckbox.checked = true;
            }
        });
    }

    async function loadSpChiTiet(page) {
        var sort = document.getElementById("sort").value;
        var search = document.getElementById("search").value;
        var url = '/admin/sell-off/san-pham-chi-tiet?page=' + page + '&size=' + size + '&sort=' + sort;
        pageProduct = page;
        if (search !== "") {
            url += '&search=' + search
        }
        const response = await fetch(url, {
            method: 'GET'
        });
        var result = await response.json();
        console.log(result)
        var list = result.content;
        var totalPage = result.totalPages;
        if (page === totalPage) {
            return;
        }
        var main = '';
        for (i = 0; i < list.length; i++) {
            var idCheckboxProductDetail = "checkboxProductDetail" + list[i].id;
            main += `<tr>
                    <td>${list[i].id}</td>
                    <td>${list[i].sp.tenSP}</td>
                    <td>${list[i].ms.ten}</td>
                    <td>${list[i].size}</td>
                    <td>${list[i].soLuong}</td>
                    <td>${formatmoney(list[i].sp.donGia)}</td>
                    <td>
                        <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="${idCheckboxProductDetail}"
                                        aria-label="..." onclick="chooseProductDetail(${list[i].id})"                                        />
                        </div>
                    </td>
                </tr>`
        }
        document.getElementById("listspct").innerHTML = main;
        await restoreCheckedState();
        var mainpage = ''
        for (i = 1; i <= totalPage; i++) {
            // mainpage += `<li onclick="loadSpChiTiet(${(Number(i) - 1)})" class="page-item"><a class="page-link" href="#listsp">${i}</a></li>`

            mainpage += `<li onclick="loadSpChiTiet(${(Number(i) - 1)})" class="pageationli"><a class="page">${i}</a></li>`
        }
        document.getElementById("pagespct").innerHTML = mainpage

        var listli = document.getElementsByClassName('pageationli');
        for (j = 0; j < listli.length; j++) {
            listli[j].classList.remove('active');
        }
        listli[page].classList.add('active')

        document.getElementById("prectsp").onclick = function () {
            loadSpChiTiet(page - 1)
        }
        document.getElementById("nextctsp").onclick = function () {
            loadSpChiTiet(page + 1)
        }
    }

    async function loadTableCart(pageNumber) {
        var url = "/api/admin/sell-off/cart/" + pageNumber;
        const response = await fetch(url, {
            method: 'GET'
        });
        pageCart = pageNumber;
        var result = await response.json();
        console.log(result);
        var list = result.content;
        var totalPage = result.totalPages;
        var number = result.number;
        var main = '';
        for (i = 0; i < list.length; i++) {
            var count = list[i].soLuong;
            main += `<tr >
                            <td scope="row">${i + 1}</td>
                            <td scope="row">${list[i].spct.sp.tenSP}</td>
                            <td scope="row">${list[i].spct.ms.ten}</td>
                            <td scope="row">${list[i].spct.size}</td>
                            <td scope="row" id="count-product-detail">
                                <div class="input-step">
                                    <button type="button" class="minus" onclick="minusQuantity(${list[i].id},${count})">–</button>
                                    <input type="number" class="product-quantity" value="${count}" min="0" max="100" readonly>
                                    <button type="button" class="plus" onclick="addQuantity(${list[i].id})">+</button>
                                </div>
                            </td>
                            <td scope="row">${formatmoney(list[i].spct.sp.donGia)}</td>
                            <td>
                                <div class="hstack gap-3 flex-warp">
                                    <div onclick="deleteCard(${list[i].id})"class="link-danger fs-15"><i class="ri-delete-bin-6-line"></i></div>
                                </div>
                                <div class="hstack gap-3 flex-warp">
                                    <div class="link-info fs-15"><i class="ri-edit-line-2"></i></div>
                                </div>
                            </td>
                     </tr>`
        }
        document.getElementById("list_product_detail_of_cart").innerHTML = main;
        var currentPage = `
            <li class="page-item">
                <button class="page-link" onclick="event.preventDefault(); loadTableCart(0)" aria-label="First">First</button>
            </li>
            <li class="page-item">
                <button class="page-link" aria-label="Previous" onclick="event.preventDefault(); loadTableCart(${number - 1 < 0 ? totalPage - 1 : number - 1})"><span aria-hidden="true">&laquo;</span></button>
            </li>
            <li class="page-item">
                <button class="page-link">${number + 1}</button>
            </li>
            <li class="page-item">
                <button class="page-link" aria-label="Next" onclick="event.preventDefault(); loadTableCart(${number + 1 === totalPage ? 0 : number + 1})">
                   <span aria-hidden="true">&raquo;</span>
                 </button>
            </li>
            <li class="page-item">
                <button class="page-link" onclick="event.preventDefault(); loadTableCart(${totalPage - 1})" aria-label="Last">Last</button>
            </li>
        `;
        document.getElementById("pagination_cart").innerHTML = currentPage;
    }


    function deleteCard(id) {
        swal.fire({
            title: "Bạn Có Muốn Xoá!",
            imageUrl: '/assets/images/cheems-meme-2.jpg',
            imageWidth: 300, // Độ rộng của ảnh
            imageHeight: 280, // Độ cao của ảnh
            confirmButtonText: 'Em muốn ạ!',
            showCancelButton: true
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/api/admin/sell-off/cart/delete/' + id,
                    method: 'GET',
                    success: function (response) {
                        console.log(response);
                        if (response === "success") {
                            loadTableCart(pageCart);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                    }
                });
            }
        })
    }

    function addQuantity(id) {
        $.ajax({
            url: '/api/admin/sell-off/cart/add-quantity/' + id,
            method: 'GET',
            success: function (response) {
                console.log(response);
                if (response === "success") {
                    loadTableCart(pageCart);
                }
                if (response === "failure") {
                    swal.fire({
                        title: "Đừng thêm nữa e!",
                        imageUrl: '/assets/images/cheems-meme-2.jpg',
                        imageWidth: 300, // Độ rộng của ảnh
                        imageHeight: 280, // Độ cao của ảnh
                        confirmButtonText: 'Dạ em biết rồi ạ!'
                    })
                    loadTableCart(pageCart);
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function minusQuantity(id, count) {
        if (count === 1) {
            swal.fire({
                title: "Bạn Có Muốn Xoá Sản Phẩm Khỏi Giỏ Hàng?",
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: "Xoá",
                denyButtonText: `Quay Về`
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/api/admin/sell-off/cart/minus-quantity/' + id,
                        method: 'GET',
                        success: function (response) {
                            console.log(response);
                            if (response === "success") {
                                loadTableCart(pageCart);
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error:', error);
                        }
                    });
                }
            });
        }
        $.ajax({
            url: '/api/admin/sell-off/cart/minus-quantity/' + id,
            method: 'GET',
            success: function (response) {
                console.log(response);
                if (response === "success") {
                    loadTableCart(pageCart);
                }

            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
            }
        });
    }

    function deleteCart(id) {
        console.log(id);
        swal.fire({
            title: "Bạn Có Muốn Xoá?",
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: "Xoá",
            denyButtonText: `Quay Về`
        }).then((result) => {
            if (result.isConfirmed) {
                var url = '/api/admin/sell-off/cart/delete/' + id;
                const promise = fetch(url, {
                    method: 'GET'
                });
                promise.then(response => {
                    if (response.status === 200) {
                        Swal.fire({
                            icon: "success",
                            title: "Xoá thành công!"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                loadTableCart(0);
                            }
                        })
                    }
                })
            }
        });
    }

    async function saveInvoice(id) {
        return new Promise((resolve, reject) => {
            if (id === null) {
                swal.fire({
                    title: "Chưa Chọn Hoá Đơn Kìa E!",
                    imageUrl: '/assets/images/cheems-meme-2.jpg',
                    imageWidth: 300,
                    imageHeight: 280,
                    confirmButtonText: 'Dạ Em Biết Rồi Ạ!'
                });
                reject(new Error("Chưa Chọn Hoá Đơn!"));
            } else {
                $.ajax({
                    url: '/api/admin/sell-off/invoice/save/' + id,
                    method: 'POST',
                    success: function (response) {
                        console.log(response);
                        resolve(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                        reject(new Error(error));
                    }
                });
            }
        });
    }

    async function exportInvoice() {
        if (selectedInvoiceId !== null && selectedProductDetailId.length > 0) {
            try {
                await saveInvoice(selectedInvoiceId);
                var urlChangeStatus = '/api/admin/sell-off/invoice/change-status/' + selectedInvoiceId;
                fetch(urlChangeStatus, {
                    method: 'GET'
                });
                var url = '/api/admin/sell-off/invoice/list-invoice/' + selectedInvoiceId;
                const response = await fetch(url, {
                    method: 'GET'
                });
                var result = await response.json();
                var list = [];
                var totalAmount = 0;
                result.forEach(function (item) {
                    list.push(item);
                });
                document.getElementById("label-modal").innerHTML = "Hoá Đơn " + list[0].dh.maDonHang;
                $('#myModal').modal('show');
                var main = '';
                const formattedCreateAt = moment(list[0].ngayTao).format('DD/MM/YY HH:mm:ss');
                for (i = 0; i < list.length; i++) {
                    var currentTotal = list[i].tongTien;
                    totalAmount += currentTotal;
                    main += `<tr>
                            <td scope="row">${i + 1}</td>
                            <td scope="row">${list[i].spct.sp.tenSP}</td>
                            <td scope="row">${list[i].spct.ms.ten}</td>
                            <td scope="row">${list[i].spct.size}</td>
                            <td scope="row">${list[i].soLuong}</td>
                            <td scope="row">${formatmoney(list[i].spct.sp.donGia)}</td>
                            <td scope="row">${formatmoney(list[i].tongTien)}</td>
                     </tr>`
                }
                document.getElementById("list_product_modal").innerHTML = main;
                document.getElementById("total-amount").innerText = formatmoney(totalAmount);
                document.getElementById("date-time").innerText = formattedCreateAt;
                loadPage(0);
                loadSpChiTiet(0);
                loadTableCart(0);
                selectedProductDetailId = [];
                selectedInvoiceId = null;
            } catch (error) {
                console.error('Error:', error);
            }
        } else if (selectedInvoiceId === null && selectedProductDetailId.length > 0) {
            swal.fire({
                title: "Hoá Đơn Chưa Được Chọn!",
                imageUrl: '/assets/images/cheems-meme-2.jpg',
                imageWidth: 300,
                imageHeight: 280,
                confirmButtonText: 'Dạ Em Biết Rồi Ạ!'
            });
        } else if (selectedInvoiceId !== null && selectedProductDetailId.length === 0) {
            swal.fire({
                title: "Sản Phẩm Chưa Được Chọn!",
                imageUrl: '/assets/images/cheems-meme-2.jpg',
                imageWidth: 300,
                imageHeight: 280,
                confirmButtonText: 'Dạ Em Biết Rồi Ạ!'
            });
        } else {
            swal.fire({
                title: "Sản Phẩm Và Hoá Đơn Chưa Được Chọn!",
                imageUrl: '/assets/images/cheems-meme-2.jpg',
                imageWidth: 300,
                imageHeight: 280,
                confirmButtonText: 'Dạ Em Biết Rồi Ạ!'
            });
        }
    }
</script>
</html>